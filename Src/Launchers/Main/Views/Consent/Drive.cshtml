<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Google Picker Example</title>

    <script type="text/javascript">

        // The Browser API key obtained from the Google API Console.
        // Replace with your own Browser API key, or your own key.
        var developerKey = 'AIzaSyDasiPdcXO5HCSWX63nWAa4xHG8h81uBQs';

        // The Client ID obtained from the Google API Console. Replace with your own Client ID.
        var clientId = "322656278343-38jp2n9oes6k0mkd2dibc4fsbj7elc3j.apps.googleusercontent.com"

        // Replace with your own project number from console.developers.google.com.
        // See "Project number" under "IAM & Admin" > "Settings"
        var appId = "322656278343";

        // Scope to use to access user's Drive items.
        var scope = ['https://www.googleapis.com/auth/drive.file'];

        var pickerApiLoaded = false;
        var oauthToken;

        // Use the Google API Loader script to load the google.picker script.
        function loadPicker() {
            gapi.load('auth', { 'callback': onAuthApiLoad });
            //gapi.load('picker', { 'callback': onPickerApiLoad });
        }

        function onAuthApiLoad() {
            window.gapi.auth.authorize(
                {
                    'client_id': clientId,
                    'scope': scope,
                    'immediate': false
                },
                handleAuthResult);
        }

        function onPickerApiLoad() {
            pickerApiLoaded = true;
            createPicker();
        }

        function onDriveApiLoad() {
            alert('Test');
        }

        function handleAuthResult(authResult) {
            if (authResult && !authResult.error) {
                oauthToken = authResult.access_token;
                //gapi.load('drive', { 'callback': onDriveApiLoad });
                //    //gapi.load('picker', { 'callback': onPickerApiLoad });
                ////    alert('drive loaded');
                ////});
                gapi.load('client', c => {
                    gapi.client.init({
                        'apiKey': developerKey,
                        // Your API key will be automatically added to the Discovery Document URLs.
                        'discoveryDocs': ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                        // clientId and scope are optional if auth is not required.
                        'clientId': clientId,
                        'scope': 'https://www.googleapis.com/auth/drive',
                    }).then(function () {
                        gapi.load('picker', { 'callback': onPickerApiLoad });
                        //debugger;
                        //gapi.client.load('drive', 'v3', d => {
                        //    alert('client loaded');
                        //});

                        // 3. Initialize and make the API request.
                        //return gapi.client.people.people.get({
                        //    'resourceName': 'people/me',
                        //    'requestMask.includeField': 'person.names'
                        //});
                    //}).then(function (response) {
                    //    console.log(response.result);
                    }, function (reason) {
                        console.log('Error: ' + reason.result.error.message);
                    });

                    //gapi.client.load('drive', 'v3', d => {
                    //    alert('client loaded');
                    //});
                    //gapi.client.init({

                    //})
                });
                //gapi.load('picker', { 'callback': onPickerApiLoad });
                //createPicker();                
            }
        }

        // Create and render a Picker object for searching images.
        function createPicker() {
            if (pickerApiLoaded && oauthToken) {
                var view = new google.picker.View(google.picker.ViewId.DOCS);
                view.setMimeTypes("image/png,image/jpeg,image/jpg");
                var picker = new google.picker.PickerBuilder()
                    .enableFeature(google.picker.Feature.NAV_HIDDEN)
                    .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                    .setAppId(appId)
                    .setOAuthToken(oauthToken)
                    .addView(view)
                    .addView(new google.picker.DocsUploadView())
                    .setDeveloperKey(developerKey)
                    .setCallback(pickerCallback)
                    .build();
                picker.setVisible(true);
            }
        }

        function loadDriveApi() {
            
        }

        // A simple callback implementation.
        function pickerCallback(data) {
            if (data.action == google.picker.Action.PICKED) {
                var fileId = data.docs[0].id;
                alert('The user selected: ' + fileId);
                //exportFile(data.docs[0]);
                var sharedUrl = shareFile(data.docs[0]);
            }
        }

        function shareFile(file) {
            var gdurl = "";
            var type = "anyone";
            var role = "reader";
            var request1 = gapi.client.request({
                'path': '/drive/v3/files/' + file.id + '/permissions',
                'method': 'POST',
                'headers': {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + oauthToken
                },
                'body': {
                    'role': role,
                    'type': type
                }
            });
            request1.execute(function (resp) {
                console.log(resp);
            });
        };

        var exportFile = function (file) {
            debugger;
            var fileID = file.id;
            var request = gapi.client.drive.files.get({ // Read more about export at https://developers.google.com/drive/v3/reference/files/export#http-request
                'fileId': fileID,
                 alt: 'media'
                //'mimeType': 'image/jpeg'
            });


            var fulfilledCallback = function (fulfilled) { // What to do when the request is fulfilled
                debugger;
                console.log("Request fulfilled!", fulfilled);
                //appendPre(fulfilled.body); // Stick the response body into the page � fulfilled.body should be where the text is
            };

            var rejectedCallback = function (rejected) { // What to do when the request is rejected
                debugger;
                console.log("Request rejected!", rejected);
            };

            // Make the request � For some reason using .execute instead of .then doesn't work; their API docs (https://developers.google.com/api-client-library/javascript/reference/referencedocs#gapiclientrequest) recommend using .then
            request.then(fulfilledCallback, rejectedCallback)

        };
    </script>
</head>
<body>
    <div id="result"></div>

    <!-- The Google API Loader script. -->
    <script type="text/javascript" src="https://apis.google.com/js/api.js?onload=loadPicker"></script>
</body>
</html>